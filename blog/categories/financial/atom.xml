<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Financial | Quantified Savagery]]></title>
  <link href="http://blog.savageevan.com/blog/categories/financial/atom.xml" rel="self"/>
  <link href="http://blog.savageevan.com/"/>
  <updated>2013-10-10T15:30:30-07:00</updated>
  <id>http://blog.savageevan.com/</id>
  <author>
    <name><![CDATA[Evan Savage]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Financial Tracking: Mint Bubbles]]></title>
    <link href="http://blog.savageevan.com/blog/2012/11/12/financial-tracking-mint-bubbles/"/>
    <updated>2012-11-12T07:00:00-08:00</updated>
    <id>http://blog.savageevan.com/blog/2012/11/12/financial-tracking-mint-bubbles</id>
    <content type="html"><![CDATA[<p>In this post I present Mint Bubbles, a <a href="http://www.nytimes.com/interactive/2012/02/13/us/politics/2013-budget-proposal-graphic.html">force-directed bubble chart</a>
visualization of exported Mint data. I explain how to use
<a href="http://en.wikipedia.org/wiki/Force-based_algorithms_(graph_drawing)">force-directed layouts</a> to produce awesome interactive visualizations
with <a href="http://d3js.org/">d3</a>, and also provide details on some of the specific tricks used
to create Mint Bubbles.</p>

<!-- more -->

<h2 id="getting-your-data">Getting Your Data</h2>

<p>Exporting your data from Mint is easy. Log into Mint and go to the
Transactions tab:</p>

<p><img src="https://lh6.googleusercontent.com/-oHWRFHUK35A/UKLVzn8tlDI/AAAAAAAAAM4/_2mADDMZ__M/s640/transactions-tab-select.jpg"></p>

<p>Scroll to the bottom pagination section. In barely-legible super-tiny
type at bottom right, there’s a link to export all your transactions:</p>

<p><img src="https://lh3.googleusercontent.com/-VSYonXZ14ns/UKLVz3M9eHI/AAAAAAAAAMs/Svbd25tzd3A/s800/transactions-export-link.jpg"></p>

<p>Clicking that link will download a file called <code>transactions.csv</code>:</p>

<p><img src="https://lh6.googleusercontent.com/-iwz7B_kEtF8/UKLV0RLGvZI/AAAAAAAAAM0/w3tqQ53CVao/s800/transactions-csv-download.jpg"></p>

<h2 id="mint-bubbles">Mint Bubbles</h2>

<p>If you’re viewing this on an RSS reader, check out the example
<a href="/blog/2012/11/12/financial-tracking-mint-bubbles/#quick-demo">on my blog</a>. You will need a browser that supports the
<a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">HTML5 File API</a>.</p>

<p>You can see the code for this demo <a href="https://github.com/candu/quantified-savagery-files/tree/master/Financial/mint-bubbles">here</a>.</p>

<p>To see a visualization of your data, drag the <code>transactions.csv</code> file from
Mint onto the <code>drag your data here</code> area below. You can also use
<a href="http://candu.github.io/quantified-savagery-files/Financial/mint-bubbles/transactions.csv">my data</a> from the last three months or so.</p>

<div id="quick-demo">
  <style type="text/css">
    #quick-demo {
      line-height: 1;
    }

    #chart {
      height: 480px;
      width: 720px;
      margin: auto;
      margin-top: 32px;
      margin-bottom: 16px;
    }
    
    .chart-active {
      border: 1px solid #DFE2E1;
      background-color: #F7F7F7;
    }
    
    #drop_zone {
      display: table;
      border: 2px dashed #bbb;
      height: 100%;
      width: 100%;
      padding: 4px;
      cursor: pointer;
    }
    
    #drop_zone p {
      display: table-cell;
      vertical-align: middle;
      text-align: center;
      font-size: 150%;
      color: #7F7F7F;
    }
    
    .hidden {
      display: none !important;
    }
    
    circle.node {
      cursor: pointer;
    }
    
    circle.circle-active {
      fill: #36f !important;
      stroke: #03f !important;
    }
    
    #caption {
      width: 720px;
      margin: auto;
      text-align: center;
      min-height: 100%;
    }
    
    #total {
      font-size: 125%;
      color: #36f;
      padding: 4px;
      margin-bottom: 8px;
    }
    
    #prompt {
      font-size: 150%;
      color: #888;
      padding: 4px;
    }
    
    #transactions_table {
      width: 100%;
      margin-bottom: 8px;
    }
    
    #quick-demo th {
      font-weight: 500;
      padding-bottom: 4px;
    }

    #quick-demo th, #quick-demo td {
      text-align: center;
    }
  </style>
  <script src="http://candu.github.io/quantified-savagery-files/lib/js/third-party/mootools.js"></script>
  <script src="http://candu.github.io/quantified-savagery-files/lib/js/third-party/d3.js"></script>
  <script src="http://candu.github.io/quantified-savagery-files/Financial/mint-bubbles/demo.js"></script>
  <div id="chart">
    <div id="drop_zone">
      <p>
        drop your data here
        <div id="progress" class="hidden">
          <progress id="progress_bar" />
        </div>
      </p>
    </div>
  </div>
  <div id="caption" class="hidden">
    <div id="prompt">
      click bubbles to see transaction details
    </div>
    <div id="total" class="hidden"></div>
    <div id="transactions" class="hidden">
      <table id="transactions_table">
        <thead>
          <tr>
            <th width="120px">Date</th>
            <th width="120px">Amount</th>
            <th width="480px">Description</th>
          </tr>
        </thead>
        <tbody id="transactions_tbody" />
      </table>
    </div>
  </div>
</div>

<h2 id="behind-the-bubbles">Behind The Bubbles</h2>

<h3 id="inspiration">Inspiration</h3>

<p>This visualization was inspired by the
<a href="http://www.nytimes.com/interactive/2012/02/13/us/politics/2013-budget-proposal-graphic.html">NYT 2013 Budget Proposal Graphic</a>,
which uses <a href="http://d3js.org/">d3.js</a> to bring
<a href="http://www.whitehouse.gov/omb/budget">Obama’s 2013 budget proposal</a>
to life as an interactive bubble chart.</p>

<p>I’d just started using <a href="https://www.mint.com/">Mint</a> for financial tracking, and this
seemed like an awesome way to visualize my personal spending patterns.
To help figure out the mechanics of the NYT visualization, I consulted
<a href="http://vallandingham.me/bubble_charts_in_d3.html">this article</a>
by <a href="http://vallandingham.me/">Jim Vallandingham</a>. He explains in detail how to create similar
visualizations using d3’s <a href="https://github.com/mbostock/d3/wiki/Force-Layout">force-directed layouts</a>, which model your
data as a set of particles moving about in space.</p>

<h3 id="importing-data">Importing Data</h3>

<p>Unlike my <a href="/blog/2012/10/22/dont-hate-cross-correlate/#quick-demo">previous</a> <a href="/blog/2012/10/17/fitbit-apis-crossfilter-and-d3/#quick-demo">visualizations</a>, I wanted this visualization
to allow you to play with your data. Enter the <a href="http://www.html5rocks.com/en/tutorials/file/dndfiles/">HTML5 File API</a>, which
allows access to files via JavaScript. First, I set up the drag-and-drop
listeners on <code>div#drop_zone</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Octopress bundles ender.js, which provides $() for DOM access; mootools</span>
</span><span class='line'><span class="cm"> * tries to play nice, so it won’t install its $() over that. I’m using</span>
</span><span class='line'><span class="cm"> * document.id() instead.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">dropZone</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">drop_zone</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">trapEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">evt</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">dragenter</span><span class="err">’</span><span class="p">,</span> <span class="nx">trapEvent</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">dragexit</span><span class="err">’</span><span class="p">,</span> <span class="nx">trapEvent</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">dragover</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">trapEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// This makes a copy icon appear during the drag operation.</span>
</span><span class='line'>  <span class="nx">evt</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">dropEffect</span> <span class="o">=</span> <span class="err">‘</span><span class="nx">copy</span><span class="err">’</span><span class="p">;</span>
</span><span class='line'><span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">drop</span><span class="err">’</span><span class="p">,</span> <span class="nx">handleFileSelect</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>dragenter</code>, <code>dragexit</code>, and <code>dragover</code> are analogous to <code>mouseenter</code>,
<code>mouseexit</code>, and <code>mouseover</code>. For those events, it suffices to call
<code>trapEvent()</code>, which prevents the browser’s default action from happening.
For instance, Chrome on Mac OS will just download the <code>transactions.csv</code> file
if you drag it into a browser tab, which is not what I want here.</p>

<p><code>drop</code> is the interesting event:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">handleFileSelect</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">trapEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">// NOTE: you might want to filter out large or invalid files here.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onloadstart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">lengthComputable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress</span><span class="err">’</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress_bar</span><span class="err">’</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="err">‘</span><span class="nx">value</span><span class="err">’</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress_bar</span><span class="err">’</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="err">‘</span><span class="nx">max</span><span class="err">’</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">lengthComputable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress_bar</span><span class="err">’</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">loaded</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">caption</span><span class="err">’</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">chart</span><span class="o">-</span><span class="nx">active</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">drop_zone</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">chart</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">chart</span><span class="o">-</span><span class="nx">active</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">buildChart</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">));</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This uses <code>FileReader.readAsText()</code> to read in the <code>transactions.csv</code> file,
with <code>d3.csv.parse()</code> for turning that CSV file into a sequence of JavaScript
objects representing the transactions. This parsing is triggered <code>onload</code>,
which fires once file I/O has completed.</p>

<p><code>onloadstart</code> and <code>onprogress</code> are used to monitor file I/O progress via the
<a href="http://www.useragentman.com/blog/2012/01/03/cross-browser-html5-progress-bars-in-depth/">HTML5 progress element</a> <code>document.id('progress_bar')</code>. Since
<code>transactions.csv</code> files are typically small, and since the “uploading” is
actually a client-local copy into browser memory, you’ll probably never see
that progress bar.</p>

<h3 id="grouping-transactions">Grouping Transactions</h3>

<p>I group the transactions by category:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">cs</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="nx">data</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">[</span><span class="err">‘</span><span class="nx">Category</span><span class="err">’</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">c</span> <span class="k">in</span> <span class="nx">cs</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">amount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">txs</span><span class="o">:</span> <span class="p">[]</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">amount</span> <span class="o">+=</span> <span class="o">+</span><span class="p">(</span><span class="nx">tx</span><span class="p">[</span><span class="err">‘</span><span class="nx">Amount</span><span class="err">’</span><span class="p">]);</span>
</span><span class='line'>  <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">txs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tx</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>amount</code> stores the total amount; note the use of <code>+(tx['Amount'])</code> to convert
CSV string values into numbers. <code>txs</code> is used for the transaction list.</p>

<p>I then convert these into nodes to be used by
<code>d3.layout.force()</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">cs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">R</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">amount</span><span class="p">)),</span>
</span><span class='line'>    <span class="nx">category</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">amount</span><span class="o">:</span> <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">amount</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">txs</span><span class="o">:</span> <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">txs</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="defining-the-layout">Defining The Layout</h3>

<p>Before building the visualization itself, I define a color gradient based on
bubble radius, picking the colors using the excellent
<a href="http://colorschemedesigner.com/">Color Scheme Designer</a>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">Rs</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">minR</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">Rs</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">maxR</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">Rs</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fill</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">minR</span><span class="p">,</span> <span class="nx">maxR</span><span class="p">])</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="err">‘#</span><span class="mi">7</span><span class="nx">EFF77</span><span class="err">’</span><span class="p">,</span> <span class="err">‘#</span><span class="mi">067500</span><span class="err">’</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now on to the visualization. First, I need to create the <a href="https://developer.mozilla.org/en-US/docs/SVG">SVG element</a>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="err">‘#</span><span class="nx">chart</span><span class="err">’</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="err">‘</span><span class="nx">svg</span><span class="o">:</span><span class="nx">svg</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">width</span><span class="err">’</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">height</span><span class="err">’</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Next, I define the behavior and styling of the bubbles:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="err">‘</span><span class="nx">circle</span><span class="p">.</span><span class="nx">node</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="err">‘</span><span class="nx">svg</span><span class="o">:</span><span class="nx">circle</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="kr">class</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="nx">node</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cx</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cy</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">r</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="err">‘</span><span class="nx">fill</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">fill</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">);</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="err">‘</span><span class="nx">stroke</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rgb</span><span class="p">(</span><span class="nx">fill</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">)).</span><span class="nx">darker</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="err">‘</span><span class="nx">stroke</span><span class="o">-</span><span class="nx">width</span><span class="err">’</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>fill(d.R)</code> uses the color gradient <code>fill</code> to make smaller bubbles lighter and
larger bubbles darker.</p>

<p>As for the force-directed layout, I start with some basic properties:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">force</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">force</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">links</span><span class="p">([])</span>          <span class="c1">// no edges between bubbles!</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">size</span><span class="p">([</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">])</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">gravity</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>      <span class="c1">// controls speed at which bubbles seek the center</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">friction</span><span class="p">(</span><span class="mf">0.95</span><span class="p">);</span>    <span class="c1">// slows down motion</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="tick-handler">Tick Handler</h3>

<p><blockquote><p>force.tick(): Runs the force layout simulation one step.</p><footer><strong>Force Layout</strong> <cite><a href='https://github.com/mbostock/d3/wiki/Force-Layout#wiki-tick'>github.com/mbostock/d3/wiki/&hellip;</a></cite></footer></blockquote></p>

<p>Force-directed layouts model your data as a set of particles in space. Those
particles are subject to various forces:</p>

<ul>
  <li><strong>Gravity:</strong> in d3, this is actually an attractive force pulling particles
towards the center of the visualization.</li>
  <li><strong>Friction:</strong> this slows down movement.</li>
  <li><strong>Tension:</strong> if nodes are connected via links (edges), they will resist being
moved apart.</li>
  <li><strong>Charge:</strong> similar to electric charge, same-signed charges repel
and opposite-signed charges attract.</li>
</ul>

<p>A layout can describe some or all of these forces. Resolving the forces is a
simple iterative process:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>while (true) {
</span><span class='line'>  for (P in particles) {
</span><span class='line'>    F = [0, 0];
</span><span class='line'>    for (f in forcesActingOn(P)) {
</span><span class='line'>      F[0] += f[0]; F[1] += f[1];
</span><span class='line'>    }
</span><span class='line'>    applyForceTo(P, F);
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>In addition to the above forces, visualizations using <code>d3.layout.force()</code> can
define their own forces via the <code>ontick</code> handler. I use this to apply two
effects:</p>

<ul>
  <li><strong>Size Sorting:</strong> similar to <a href="http://en.wikipedia.org/wiki/Granular_convection">granular convection</a>,
larger bubbles will rise while smaller bubbles sink.</li>
  <li><strong>Collision Detection:</strong> I prevent bubbles from intersecting, since that
makes it easier to select them.</li>
</ul>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">floatPoint</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">minR</span><span class="p">,</span> <span class="nx">maxR</span><span class="p">])</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="nx">h</span> <span class="o">*</span> <span class="mf">0.65</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">]);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">force</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="err">‘</span><span class="nx">tick</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// vertical size sorting</span>
</span><span class='line'>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">floatPoint</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">e</span><span class="p">.</span><span class="nx">alpha</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">// collision detection</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">quadtree</span><span class="p">(</span><span class="nx">nodes</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">q</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">quad</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">d2</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">d2</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="p">(</span><span class="nx">d2</span> <span class="o">!==</span> <span class="nx">d1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">y</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">L</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">R</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span> <span class="o">+</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">R</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">L</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nx">R</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">L</span> <span class="o">=</span> <span class="p">(</span><span class="nx">L</span> <span class="o">-</span> <span class="nx">R</span><span class="p">)</span> <span class="o">/</span> <span class="nx">L</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">Lx</span> <span class="o">=</span> <span class="nx">L</span> <span class="o">*</span> <span class="nx">x</span><span class="p">,</span>
</span><span class='line'>              <span class="nx">Ly</span> <span class="o">=</span> <span class="nx">L</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">Lx</span><span class="p">;</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">Ly</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">d2</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">Lx</span><span class="p">;</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">Ly</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// This short-circuits visit() for quadtree nodes that can’t collide with</span>
</span><span class='line'>      <span class="c1">// d1, resulting in O(n log n) collision detection.</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>        <span class="nx">x1</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="nx">x2</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="nx">y1</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="nx">y2</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">node</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cx</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cy</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="alpha-and-size-sorting">Alpha and Size Sorting</h3>

<p>What’s <code>e.alpha</code>? This is described cryptically in the
<a href="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start">d3.js documentation</a>:</p>

<p><blockquote><p>Internally, the layout uses a cooling parameter alpha which controls the layout temperature: as the physical simulation converges on a stable layout, the temperature drops, causing nodes to move more slowly.</p><footer><strong>Force Layout</strong> <cite><a href='https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start'>github.com/mbostock/d3/wiki/&hellip;</a></cite></footer></blockquote></p>

<p>A look at the <a href="https://github.com/mbostock/d3/blob/master/src/layout/force.js#L46">code for d3.layout.force()</a>
provides some insight into what’s happening here:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">force</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// simulated annealing, basically</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="nx">alpha</span> <span class="o">*=</span> <span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="p">.</span><span class="mi">005</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">event</span><span class="p">.</span><span class="nx">end</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="err">“</span><span class="nx">end</span><span class="err">”</span><span class="p">,</span> <span class="nx">alpha</span><span class="o">:</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// …</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Let’s look at the size sorting code again:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">nodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">floatPoint</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">e</span><span class="p">.</span><span class="nx">alpha</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>floatPoint(d.R)</code> computes a “desired height” for the node <code>d</code>. The <code>d.y</code>
adjustment moves <code>d</code> towards that height, using <code>e.alpha</code> to slow down the
sorting adjustment as the layout “cools” into its final state.</p>

<h3 id="collision-detection">Collision Detection</h3>

<p>The collision detection code is cribbed from
<a href="http://mbostock.github.com/d3/talk/20111018/collision.html">this page</a>,
which is part of a <a href="http://mbostock.github.com/d3/talk/20111018/#0">talk</a>
given by <a href="http://bost.ocks.org/mike/">Mike Bostock</a> on d3.</p>

<h2 id="up-next">Up Next</h2>

<p>I’m currently working on a post for the <a href="http://quantifiedself.com/">main Quantified Self blog</a>,
in which I’m planning to feature another cool visualization for personal data.
Aside from that, I’m hoping to use an upcoming post to dissect my Mint data in
more detail. Keep posted!</p>
]]></content>
  </entry>
  
</feed>
