<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Technical | Quantified Savagery]]></title>
  <link href="http://blog.savageevan.com/blog/categories/technical/atom.xml" rel="self"/>
  <link href="http://blog.savageevan.com/"/>
  <updated>2013-01-31T14:43:08-08:00</updated>
  <id>http://blog.savageevan.com/</id>
  <author>
    <name><![CDATA[Evan Savage]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[What I'll Look Like In 50 Years]]></title>
    <link href="http://blog.savageevan.com/blog/2013/01/31/what-ill-look-like-in-50-years/"/>
    <updated>2013-01-31T12:43:00-08:00</updated>
    <id>http://blog.savageevan.com/blog/2013/01/31/what-ill-look-like-in-50-years</id>
    <content type="html"><![CDATA[<p>I spent a few weeks in the not-so-frozen Canadian northlands over the winter
holidays. While there, I had the chance to visit an old childhood favorite:
the <a href="http://ontariosciencecentre.ca/">Ontario Science Centre</a>, six floors of science-based awesomeness.
One of their current exhibits, the <a href="http://ontariosciencecentre.ca/aging/">Amazing Aging Machine</a>, uses a
computer vision software package called <a href="http://aprilage.com/">APRIL</a> to predict how your
face will change over the next 50 years.</p>

<p>In this post, I explore my results from that exhibit alongside a customized
aging I performed using the <a href="http://www.aprilage.com/AprilAPI_V2.pdf">APRIL API</a>.</p>

<!-- more -->

<h2 id="present-me">Present Me</h2>

<p>It’s not the most flattering photo, but here I am at 26:</p>

<p><img src="https://lh4.googleusercontent.com/-8qaAivSLFrI/UQrbKiU3JZI/AAAAAAAAARY/9e7IvKZUB00/s288/aging1.jpg"></p>

<h2 id="future-me">Future Me</h2>

<h3 id="take-one-amazing-aging-machine">Take One: Amazing Aging Machine</h3>

<p>First, my face balloons out massively:</p>

<p><img src="https://lh4.googleusercontent.com/-LCFkNNtDiJg/UQrbKwGOIQI/AAAAAAAAARg/SS9o98axBtU/s288/aging2.jpg"></p>

<p>Next, my cheek bones set downwards:</p>

<p><img src="https://lh5.googleusercontent.com/-VZhuI1uOVQk/UQrbLTKdBXI/AAAAAAAAARo/LHKV6cGEBGA/s288/aging3.jpg">
<img src="https://lh6.googleusercontent.com/-aNcc-FC_4yk/UQrbL53IPpI/AAAAAAAAARs/DRf3ySCxPs4/s288/aging4.jpg"></p>

<p>Finally, my face leans up and wrinkles a tiny bit:</p>

<p><img src="https://lh6.googleusercontent.com/-F8xBzpDWsM4/UQrbMUOukwI/AAAAAAAAAR0/cRqPDd_wYPM/s288/aging5.jpg"></p>

<h3 id="take-two-april-api">Take Two: APRIL API</h3>

<p>For this run, I had access to the raw aging metadata, so I could see
exactly how old APRIL thought I was at each point in the aging sequence.</p>

<p>From 26 to 28, there’s not much change:</p>

<p><img src="https://lh6.googleusercontent.com/-u36fDGLeI0Y/UQrbNrKtZyI/AAAAAAAAASE/NQSn0Y5uCng/s288/age28.jpg"></p>

<p>Then, by age 35, my face elongates slightly:</p>

<p><img src="https://lh4.googleusercontent.com/-cRxKskiAyos/UQrbOiA_OjI/AAAAAAAAASM/GBFlRfZtXnc/s288/age35.jpg"></p>

<p>I while away the next couple of decades in relative facial stasis. The
most pronounced change is in my skin, which pales gradually with age:</p>

<p><img src="https://lh6.googleusercontent.com/-gYCoSmKbBDw/UQrbO46gohI/AAAAAAAAASY/X8RoWKpGT_8/s288/age47.jpg">
<img src="https://lh6.googleusercontent.com/-dWkaa-neumY/UQrbPgkBVtI/AAAAAAAAASg/ebWh4i14qYk/s288/age55.jpg"></p>

<p>Finally, age catches up with me, and I wrinkle into a haunted
septuagenarian:</p>

<p><img src="https://lh5.googleusercontent.com/-JNBO6QMu-Xg/UQrbP9uzUUI/AAAAAAAAASo/Dj43_1l46Zo/s288/age61.jpg">
<img src="https://lh4.googleusercontent.com/-w7zx8Ql3PnM/UQrbQO2pqVI/AAAAAAAAASw/9HJrW1EUz2c/s288/age67.jpg">
<img src="https://lh5.googleusercontent.com/-RNgo0CglAjs/UQrbQtlY69I/AAAAAAAAAS0/OXD8Yqf63og/s288/age72.jpg"></p>

<p>A few changes, each very minor, contribute to my forlorn expression over
these last three photos.</p>

<ul>
  <li>The <em>eyes get slightly rounder</em>, as though they’re welling up.</li>
  <li><em>Wrinkling above the eyes</em> gives the impression of a furrowed brow.</li>
  <li>The face <em>elongates yet again</em>, creating a drawn expression.</li>
  <li>As part of the elongation of the face, the <em>mouth corners sag downwards</em>
into the merest hint of a frown.</li>
</ul>

<p>Note the lack of deep forehead and upper nose creases which normally
accompany the furrowed brow expression. The mere suggestion of it on the eyes
is enough to trigger our expression recognition! It’s amazing how sensitive
we are to minute variations in facial muscle position.</p>

<h3 id="summary">Summary</h3>

<p>These images provide two divergent visions for my distant future:</p>

<p><img src="https://lh6.googleusercontent.com/-F8xBzpDWsM4/UQrbMUOukwI/AAAAAAAAAR0/cRqPDd_wYPM/s288/aging5.jpg">
<img src="https://lh5.googleusercontent.com/-RNgo0CglAjs/UQrbQtlY69I/AAAAAAAAAS0/OXD8Yqf63og/s288/age72.jpg"></p>

<p>For comparison, here’s my father in his late 50s, looking quite a bit happier:</p>

<p><img src="http://farm4.staticflickr.com/3177/2828216200_5846e31c4a_z.jpg"></p>

<h2 id="why-were-those-so-different">Why Were Those So Different?</h2>

<p><blockquote><p>…the machine uses state-of-the-art aging software developed in partnership with Aprilage Development Inc. of Toronto to add decades to the faces of 8-12 year olds.</p><footer><strong>The Amazing Aging Machine</strong> <cite><a href='http://ontariosciencecentre.ca/aging/'>ontariosciencecentre.ca/aging/&hellip;</a></cite></footer></blockquote></p>

<p>The Amazing Aging Machine is calibrated for ages 8-12, likely to match 
the Ontario Science Centre’s target demographic. (Sadly, I couldn’t find
detailed visitor demographic data!) In my case, this creates an awkward
puffy look: it’s applying changes in facial structure through adolescence,
when much of our bone growth occurs.</p>

<p>By contrast, the APRIL API asks for your current age, allowing it to more
correctly calibrate its models. As a result, the second set of faces exhibits
relatively little change in shape.</p>

<h2 id="what-do-i-get-out-of-this">What Do I Get Out Of This?</h2>

<p>Although my face is unlikely to match either of these faces at 72, this
experiment provides some insight into how our faces change with age. After
all, the APRIL face aging models are based on real face data. They represent
a sort of statistical average of the aging process.</p>

<p>Also, I get the vaguely warm feeling that comes with having contributed to our
<a href="http://vimeo.com/29052688">collective intelligence</a>. I provided APRIL
with a real age-labelled face, which will likely be used to help train future
models.</p>

<h2 id="appendix-how-to-use-the-april-api">Appendix: How To Use The APRIL API</h2>

<p>For the more technically-minded, I’ve provided a quick walkthrough of the
API aging pipeline. For all the gritty details, consult the <a href="http://www.aprilage.com/AprilAPI_V2.pdf">API docs</a>.</p>

<p>Before starting, I highly recommend installing a tool like <a href="https://github.com/jmhodges/jsonpp">jsonpp</a>;
it makes it much easier to read API results.</p>

<p>The first step is manual: you need to register at <a href="http://www.ageme.com/">ageme.com</a>, then
click the confirmation link in your email.</p>

<p><img src="https://lh5.googleusercontent.com/-wuu_sRDb7qQ/UQrtRmoofNI/AAAAAAAAATE/l7CAexc1_ZY/s400/ageme_register.jpg"></p>

<p>The next step is uploading an image, but let’s check first that the API
works by retrieving our user info:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/userInfo
</span><span class='line'>{“result_code”:0,”message”:”Unauthorized”}</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Oops! We haven’t authenticated ourselves. The Authorization header uses a
brain-dead and highly insecure <code>base64</code> encoding:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -c “import base64; print base64.encodestring(‘username:password’)”
</span><span class='line'>dXNlcm5hbWU6cGFzc3dvcmQ=</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>(Obviously this isn’t my real username/password. Substitute yours above and
use the resulting <code>base64</code>-encoded string in the <code>Authorization</code> headers
below. I’ll use this bogus value to illustrate the flow.)</p>

<p>With the correct header, we can try fetching the user info again:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/userInfo | jsonpp 
</span><span class='line'>{
</span><span class='line'>  “uri”: “http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com”,
</span><span class='line'>  “email”: “savage.evan@gmail.com”,
</span><span class='line'>  “tokens”: 0,
</span><span class='line'>  “numOfAgings”: 1,
</span><span class='line'>  “role”: “user”
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Great! Now we can POST an image to the uploading endpoint with <code>curl</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -F ‘filename=aging1.jpg’ -F ‘image=@/Users/candu/Desktop/aging1.jpg’ -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/images</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Another manual step: before proceeding, you’ll need to purchase a token on
the <a href="http://www.ageme.com/">ageme.com</a> site. At time of writing, this cost $3.99; I looked for
active promotion codes, but couldn’t find any.</p>

<p><img src="https://lh6.googleusercontent.com/-co9vyFu4uJQ/UQrtSM1T8mI/AAAAAAAAATM/8ozrK3aiGjk/s400/ageme_buytokens.jpg"></p>

<p>With your aging token purchased, you can now create an aging document. This
lets APRIL know your age and ethnicity, which helps it to select the
appropriate models for your particular aging sequence. It also identifies the
starting image of that sequence via the <code>imageId</code> returned during image upload.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H ‘Content-Type: application/json’ -d ‘{“document”: {“gender”: “male”, “age”: 26, “name”: “Evan”, “ethnicity”: “Caucasian”}, “imageId”: 2371944}}’ -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/documents</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We’re ready to run the aging process. There’s a single method <code>detectMatchAge</code>
for performing all three steps, but I’ll break it down into the component
steps here:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -X POST -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/pointDetection
</span><span class='line'>$ while true; do curl -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/status; done
</span><span class='line'>$ curl -X POST -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/match
</span><span class='line'>$ while true; do curl -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/status; done
</span><span class='line'>$ curl -H ‘Content-Type: application/json’ -d ‘{“sequenceType”: “Max72”, “sequences”: [{“smoking”: 0, “sunExposure”: 0, “multiplier”: 1}]}’ -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/aging
</span><span class='line'>$ while true; do curl -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/status; done</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Note the <code>while</code> loops, which wait for each step to complete. Once all steps
are completed, we retrieve the aging results:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H “Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=” http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/results &gt; aging_results.json
</span><span class='line'>$ cat aging_results.json | jsonpp | head -15
</span><span class='line'>[
</span><span class='line'>  {
</span><span class='line'>    “uri”: “http://www.ageme.com/AprilAPI/users/savage.evan@gmail.com/documents/2371973/results/76647”,
</span><span class='line'>    “status”: “done”,
</span><span class='line'>    “sequenceType”: “Max72”,
</span><span class='line'>    “sequences”: [
</span><span class='line'>      {
</span><span class='line'>        “smoking”: 0.0,
</span><span class='line'>        “sunExposure”: 0.0,
</span><span class='line'>        “multiplier”: 1.0,
</span><span class='line'>        “images”: [
</span><span class='line'>          {
</span><span class='line'>            “age”: 26,
</span><span class='line'>            “uri”: “http://www.ageme.com/AprilAPI/images/IhLAo8Sp”
</span><span class='line'>          },</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Finally, I wrote a bit of <a href="https://github.com/candu/quantified-savagery-files/blob/master/Aging/fetch_aging.py">Python glue</a> to fetch the URLs and name
them by age:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib2</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'><span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="err">‘</span><span class="n">sequences</span><span class="err">’</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="err">‘</span><span class="n">images</span><span class="err">’</span><span class="p">]</span>
</span><span class='line'><span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="err">‘</span><span class="n">uri</span><span class="err">’</span><span class="p">])</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="err">‘</span><span class="n">age</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">.</span><span class="n">jpg</span><span class="err">’</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="err">‘</span><span class="n">age</span><span class="err">’</span><span class="p">])</span>
</span><span class='line'>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="err">‘</span><span class="n">w</span><span class="err">’</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>With this, we can fetch the images:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python fetch_aging.py &lt; aging_results.json</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>And that’s it! Most of the process uses <code>curl</code>, with minimal leaning
on Python for its <code>base64</code> module.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Financial Tracking: Mint Bubbles]]></title>
    <link href="http://blog.savageevan.com/blog/2012/11/12/financial-tracking-mint-bubbles/"/>
    <updated>2012-11-12T07:00:00-08:00</updated>
    <id>http://blog.savageevan.com/blog/2012/11/12/financial-tracking-mint-bubbles</id>
    <content type="html"><![CDATA[<p>In this post I present Mint Bubbles, a <a href="http://www.nytimes.com/interactive/2012/02/13/us/politics/2013-budget-proposal-graphic.html">force-directed bubble chart</a>
visualization of exported Mint data. I explain how to use
<a href="http://en.wikipedia.org/wiki/Force-based_algorithms_(graph_drawing)">force-directed layouts</a> to produce awesome interactive visualizations
with <a href="http://d3js.org/">d3</a>, and also provide details on some of the specific tricks used
to create Mint Bubbles.</p>

<!-- more -->

<h2 id="getting-your-data">Getting Your Data</h2>

<p>Exporting your data from Mint is easy. Log into Mint and go to the
Transactions tab:</p>

<p><img src="https://lh6.googleusercontent.com/-oHWRFHUK35A/UKLVzn8tlDI/AAAAAAAAAM4/_2mADDMZ__M/s640/transactions-tab-select.jpg"></p>

<p>Scroll to the bottom pagination section. In barely-legible super-tiny
type at bottom right, there’s a link to export all your transactions:</p>

<p><img src="https://lh3.googleusercontent.com/-VSYonXZ14ns/UKLVz3M9eHI/AAAAAAAAAMs/Svbd25tzd3A/s800/transactions-export-link.jpg"></p>

<p>Clicking that link will download a file called <code>transactions.csv</code>:</p>

<p><img src="https://lh6.googleusercontent.com/-iwz7B_kEtF8/UKLV0RLGvZI/AAAAAAAAAM0/w3tqQ53CVao/s800/transactions-csv-download.jpg"></p>

<h2 id="mint-bubbles">Mint Bubbles</h2>

<p>If you’re viewing this on an RSS reader, check out the example
<a href="/blog/2012/11/12/financial-tracking-mint-bubbles/#quick-demo">on my blog</a>. You will need a browser that supports the
<a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">HTML5 File API</a>.</p>

<p>You can see the code for this demo <a href="https://github.com/candu/quantified-savagery-files/tree/master/Financial/mint-bubbles">here</a>.</p>

<p>To see a visualization of your data, drag the <code>transactions.csv</code> file from
Mint onto the <code>drag your data here</code> area below. You can also use
<a href="https://raw.github.com/candu/quantified-savagery-files/master/Financial/mint-bubbles/transactions.csv">my data</a> from the last three months or so.</p>

<div id="quick-demo">
  <style type="text/css">
    #quick-demo {
      line-height: 1;
    }

    #chart {
      height: 480px;
      width: 720px;
      margin: auto;
      margin-top: 32px;
      margin-bottom: 16px;
    }
    
    .chart-active {
      border: 1px solid #DFE2E1;
      background-color: #F7F7F7;
    }
    
    #drop_zone {
      display: table;
      border: 2px dashed #bbb;
      height: 100%;
      width: 100%;
      padding: 4px;
      cursor: pointer;
    }
    
    #drop_zone p {
      display: table-cell;
      vertical-align: middle;
      text-align: center;
      font-size: 150%;
      color: #7F7F7F;
    }
    
    .hidden {
      display: none !important;
    }
    
    circle.node {
      cursor: pointer;
    }
    
    circle.circle-active {
      fill: #36f !important;
      stroke: #03f !important;
    }
    
    #caption {
      width: 720px;
      margin: auto;
      text-align: center;
      min-height: 100%;
    }
    
    #total {
      font-size: 125%;
      color: #36f;
      padding: 4px;
      margin-bottom: 8px;
    }
    
    #prompt {
      font-size: 150%;
      color: #888;
      padding: 4px;
    }
    
    #transactions_table {
      width: 100%;
      margin-bottom: 8px;
    }
    
    #quick-demo th {
      font-weight: 500;
      padding-bottom: 4px;
    }

    #quick-demo th, #quick-demo td {
      text-align: center;
    }
  </style>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/lib/js/third-party/mootools.js"></script>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/lib/js/third-party/d3.js"></script>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/Financial/mint-bubbles/demo.js"></script>
  <div id="chart">
    <div id="drop_zone">
      <p>
        drop your data here
        <div id="progress" class="hidden">
          <progress id="progress_bar" />
        </div>
      </p>
    </div>
  </div>
  <div id="caption" class="hidden">
    <div id="prompt">
      click bubbles to see transaction details
    </div>
    <div id="total" class="hidden"></div>
    <div id="transactions" class="hidden">
      <table id="transactions_table">
        <thead>
          <tr>
            <th width="120px">Date</th>
            <th width="120px">Amount</th>
            <th width="480px">Description</th>
          </tr>
        </thead>
        <tbody id="transactions_tbody" />
      </table>
    </div>
  </div>
</div>

<h2 id="behind-the-bubbles">Behind The Bubbles</h2>

<h3 id="inspiration">Inspiration</h3>

<p>This visualization was inspired by the
<a href="http://www.nytimes.com/interactive/2012/02/13/us/politics/2013-budget-proposal-graphic.html">NYT 2013 Budget Proposal Graphic</a>,
which uses <a href="http://d3js.org/">d3.js</a> to bring
<a href="http://www.whitehouse.gov/omb/budget">Obama’s 2013 budget proposal</a>
to life as an interactive bubble chart.</p>

<p>I’d just started using <a href="https://www.mint.com/">Mint</a> for financial tracking, and this
seemed like an awesome way to visualize my personal spending patterns.
To help figure out the mechanics of the NYT visualization, I consulted
<a href="http://vallandingham.me/bubble_charts_in_d3.html">this article</a>
by <a href="http://vallandingham.me/">Jim Vallandingham</a>. He explains in detail how to create similar
visualizations using d3’s <a href="https://github.com/mbostock/d3/wiki/Force-Layout">force-directed layouts</a>, which model your
data as a set of particles moving about in space.</p>

<h3 id="importing-data">Importing Data</h3>

<p>Unlike my <a href="/blog/2012/10/22/dont-hate-cross-correlate/#quick-demo">previous</a> <a href="/blog/2012/10/17/fitbit-apis-crossfilter-and-d3/#quick-demo">visualizations</a>, I wanted this visualization
to allow you to play with your data. Enter the <a href="http://www.html5rocks.com/en/tutorials/file/dndfiles/">HTML5 File API</a>, which
allows access to files via JavaScript. First, I set up the drag-and-drop
listeners on <code>div#drop_zone</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Octopress bundles ender.js, which provides $() for DOM access; mootools</span>
</span><span class='line'><span class="cm"> * tries to play nice, so it won’t install its $() over that. I’m using</span>
</span><span class='line'><span class="cm"> * document.id() instead.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">dropZone</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">drop_zone</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">trapEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">evt</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">dragenter</span><span class="err">’</span><span class="p">,</span> <span class="nx">trapEvent</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">dragexit</span><span class="err">’</span><span class="p">,</span> <span class="nx">trapEvent</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">dragover</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">trapEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">// This makes a copy icon appear during the drag operation.</span>
</span><span class='line'>  <span class="nx">evt</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">dropEffect</span> <span class="o">=</span> <span class="err">‘</span><span class="nx">copy</span><span class="err">’</span><span class="p">;</span>
</span><span class='line'><span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'><span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="err">‘</span><span class="nx">drop</span><span class="err">’</span><span class="p">,</span> <span class="nx">handleFileSelect</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>dragenter</code>, <code>dragexit</code>, and <code>dragover</code> are analogous to <code>mouseenter</code>,
<code>mouseexit</code>, and <code>mouseover</code>. For those events, it suffices to call
<code>trapEvent()</code>, which prevents the browser’s default action from happening.
For instance, Chrome on Mac OS will just download the <code>transactions.csv</code> file
if you drag it into a browser tab, which is not what I want here.</p>

<p><code>drop</code> is the interesting event:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">handleFileSelect</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">trapEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">// NOTE: you might want to filter out large or invalid files here.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onloadstart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">lengthComputable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress</span><span class="err">’</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress_bar</span><span class="err">’</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="err">‘</span><span class="nx">value</span><span class="err">’</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress_bar</span><span class="err">’</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="err">‘</span><span class="nx">max</span><span class="err">’</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">lengthComputable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress_bar</span><span class="err">’</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">loaded</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">caption</span><span class="err">’</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">chart</span><span class="o">-</span><span class="nx">active</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">progress</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">drop_zone</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">hidden</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="err">‘</span><span class="nx">chart</span><span class="err">’</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="err">‘</span><span class="nx">chart</span><span class="o">-</span><span class="nx">active</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">buildChart</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">));</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This uses <code>FileReader.readAsText()</code> to read in the <code>transactions.csv</code> file,
with <code>d3.csv.parse()</code> for turning that CSV file into a sequence of JavaScript
objects representing the transactions. This parsing is triggered <code>onload</code>,
which fires once file I/O has completed.</p>

<p><code>onloadstart</code> and <code>onprogress</code> are used to monitor file I/O progress via the
<a href="http://www.useragentman.com/blog/2012/01/03/cross-browser-html5-progress-bars-in-depth/">HTML5 progress element</a> <code>document.id('progress_bar')</code>. Since
<code>transactions.csv</code> files are typically small, and since the “uploading” is
actually a client-local copy into browser memory, you’ll probably never see
that progress bar.</p>

<h3 id="grouping-transactions">Grouping Transactions</h3>

<p>I group the transactions by category:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">cs</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="nx">data</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">[</span><span class="err">‘</span><span class="nx">Category</span><span class="err">’</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">c</span> <span class="k">in</span> <span class="nx">cs</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">amount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">txs</span><span class="o">:</span> <span class="p">[]</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">amount</span> <span class="o">+=</span> <span class="o">+</span><span class="p">(</span><span class="nx">tx</span><span class="p">[</span><span class="err">‘</span><span class="nx">Amount</span><span class="err">’</span><span class="p">]);</span>
</span><span class='line'>  <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">txs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tx</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>amount</code> stores the total amount; note the use of <code>+(tx['Amount'])</code> to convert
CSV string values into numbers. <code>txs</code> is used for the transaction list.</p>

<p>I then convert these into nodes to be used by
<code>d3.layout.force()</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">cs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">R</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">amount</span><span class="p">)),</span>
</span><span class='line'>    <span class="nx">category</span><span class="o">:</span> <span class="nx">c</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">amount</span><span class="o">:</span> <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">amount</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">txs</span><span class="o">:</span> <span class="nx">cs</span><span class="p">[</span><span class="nx">c</span><span class="p">].</span><span class="nx">txs</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="defining-the-layout">Defining The Layout</h3>

<p>Before building the visualization itself, I define a color gradient based on
bubble radius, picking the colors using the excellent
<a href="http://colorschemedesigner.com/">Color Scheme Designer</a>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">Rs</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">minR</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">Rs</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">maxR</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">Rs</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fill</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">minR</span><span class="p">,</span> <span class="nx">maxR</span><span class="p">])</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="err">‘#</span><span class="mi">7</span><span class="nx">EFF77</span><span class="err">’</span><span class="p">,</span> <span class="err">‘#</span><span class="mi">067500</span><span class="err">’</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now on to the visualization. First, I need to create the <a href="https://developer.mozilla.org/en-US/docs/SVG">SVG element</a>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="err">‘#</span><span class="nx">chart</span><span class="err">’</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="err">‘</span><span class="nx">svg</span><span class="o">:</span><span class="nx">svg</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">width</span><span class="err">’</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">height</span><span class="err">’</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Next, I define the behavior and styling of the bubbles:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="err">‘</span><span class="nx">circle</span><span class="p">.</span><span class="nx">node</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="err">‘</span><span class="nx">svg</span><span class="o">:</span><span class="nx">circle</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="kr">class</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="nx">node</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cx</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cy</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">r</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="err">‘</span><span class="nx">fill</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">fill</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">);</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="err">‘</span><span class="nx">stroke</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rgb</span><span class="p">(</span><span class="nx">fill</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">)).</span><span class="nx">darker</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="err">‘</span><span class="nx">stroke</span><span class="o">-</span><span class="nx">width</span><span class="err">’</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>fill(d.R)</code> uses the color gradient <code>fill</code> to make smaller bubbles lighter and
larger bubbles darker.</p>

<p>As for the force-directed layout, I start with some basic properties:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">force</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">force</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">links</span><span class="p">([])</span>          <span class="c1">// no edges between bubbles!</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">size</span><span class="p">([</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">])</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">gravity</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>      <span class="c1">// controls speed at which bubbles seek the center</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">friction</span><span class="p">(</span><span class="mf">0.95</span><span class="p">);</span>    <span class="c1">// slows down motion</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="tick-handler">Tick Handler</h3>

<p><blockquote><p>force.tick(): Runs the force layout simulation one step.</p><footer><strong>Force Layout</strong> <cite><a href='https://github.com/mbostock/d3/wiki/Force-Layout#wiki-tick'>github.com/mbostock/d3/wiki/&hellip;</a></cite></footer></blockquote></p>

<p>Force-directed layouts model your data as a set of particles in space. Those
particles are subject to various forces:</p>

<ul>
  <li><strong>Gravity:</strong> in d3, this is actually an attractive force pulling particles
towards the center of the visualization.</li>
  <li><strong>Friction:</strong> this slows down movement.</li>
  <li><strong>Tension:</strong> if nodes are connected via links (edges), they will resist being
moved apart.</li>
  <li><strong>Charge:</strong> similar to electric charge, same-signed charges repel
and opposite-signed charges attract.</li>
</ul>

<p>A layout can describe some or all of these forces. Resolving the forces is a
simple iterative process:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>while (true) {
</span><span class='line'>  for (P in particles) {
</span><span class='line'>    F = [0, 0];
</span><span class='line'>    for (f in forcesActingOn(P)) {
</span><span class='line'>      F[0] += f[0]; F[1] += f[1];
</span><span class='line'>    }
</span><span class='line'>    applyForceTo(P, F);
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>In addition to the above forces, visualizations using <code>d3.layout.force()</code> can
define their own forces via the <code>ontick</code> handler. I use this to apply two
effects:</p>

<ul>
  <li><strong>Size Sorting:</strong> similar to <a href="http://en.wikipedia.org/wiki/Granular_convection">granular convection</a>,
larger bubbles will rise while smaller bubbles sink.</li>
  <li><strong>Collision Detection:</strong> I prevent bubbles from intersecting, since that
makes it easier to select them.</li>
</ul>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">floatPoint</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">minR</span><span class="p">,</span> <span class="nx">maxR</span><span class="p">])</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="nx">h</span> <span class="o">*</span> <span class="mf">0.65</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span> <span class="mf">0.35</span><span class="p">]);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">force</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="err">‘</span><span class="nx">tick</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// vertical size sorting</span>
</span><span class='line'>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">floatPoint</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">e</span><span class="p">.</span><span class="nx">alpha</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">// collision detection</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">quadtree</span><span class="p">(</span><span class="nx">nodes</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">q</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">quad</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">d2</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">d2</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="p">(</span><span class="nx">d2</span> <span class="o">!==</span> <span class="nx">d1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">y</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">L</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">R</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span> <span class="o">+</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">R</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">L</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nx">R</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">L</span> <span class="o">=</span> <span class="p">(</span><span class="nx">L</span> <span class="o">-</span> <span class="nx">R</span><span class="p">)</span> <span class="o">/</span> <span class="nx">L</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">Lx</span> <span class="o">=</span> <span class="nx">L</span> <span class="o">*</span> <span class="nx">x</span><span class="p">,</span>
</span><span class='line'>              <span class="nx">Ly</span> <span class="o">=</span> <span class="nx">L</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">Lx</span><span class="p">;</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">Ly</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">d2</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">Lx</span><span class="p">;</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">Ly</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// This short-circuits visit() for quadtree nodes that can’t collide with</span>
</span><span class='line'>      <span class="c1">// d1, resulting in O(n log n) collision detection.</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>        <span class="nx">x1</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="nx">x2</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="nx">y1</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="nx">y2</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="p">(</span><span class="nx">d1</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">R</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">node</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cx</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="err">‘</span><span class="nx">cy</span><span class="err">’</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="alpha-and-size-sorting">Alpha and Size Sorting</h3>

<p>What’s <code>e.alpha</code>? This is described cryptically in the
<a href="https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start">d3.js documentation</a>:</p>

<p><blockquote><p>Internally, the layout uses a cooling parameter alpha which controls the layout temperature: as the physical simulation converges on a stable layout, the temperature drops, causing nodes to move more slowly.</p><footer><strong>Force Layout</strong> <cite><a href='https://github.com/mbostock/d3/wiki/Force-Layout#wiki-start'>github.com/mbostock/d3/wiki/&hellip;</a></cite></footer></blockquote></p>

<p>A look at the <a href="https://github.com/mbostock/d3/blob/master/src/layout/force.js#L46">code for d3.layout.force()</a>
provides some insight into what’s happening here:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">force</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// simulated annealing, basically</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="nx">alpha</span> <span class="o">*=</span> <span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="p">.</span><span class="mi">005</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">event</span><span class="p">.</span><span class="nx">end</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="err">“</span><span class="nx">end</span><span class="err">”</span><span class="p">,</span> <span class="nx">alpha</span><span class="o">:</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// …</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Let’s look at the size sorting code again:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">nodes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">floatPoint</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">e</span><span class="p">.</span><span class="nx">alpha</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>floatPoint(d.R)</code> computes a “desired height” for the node <code>d</code>. The <code>d.y</code>
adjustment moves <code>d</code> towards that height, using <code>e.alpha</code> to slow down the
sorting adjustment as the layout “cools” into its final state.</p>

<h3 id="collision-detection">Collision Detection</h3>

<p>The collision detection code is cribbed from
<a href="http://mbostock.github.com/d3/talk/20111018/collision.html">this page</a>,
which is part of a <a href="http://mbostock.github.com/d3/talk/20111018/#0">talk</a>
given by <a href="http://bost.ocks.org/mike/">Mike Bostock</a> on d3.</p>

<h2 id="up-next">Up Next</h2>

<p>I’m currently working on a post for the <a href="http://quantifiedself.com/">main Quantified Self blog</a>,
in which I’m planning to feature another cool visualization for personal data.
Aside from that, I’m hoping to use an upcoming post to dissect my Mint data in
more detail. Keep posted!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Persistent Location Tracking: Looking For A Few Good Data Points]]></title>
    <link href="http://blog.savageevan.com/blog/2012/11/02/persistent-location-tracking-looking-for-a-few-good-data-points/"/>
    <updated>2012-11-02T16:38:00-07:00</updated>
    <id>http://blog.savageevan.com/blog/2012/11/02/persistent-location-tracking-looking-for-a-few-good-data-points</id>
    <content type="html"><![CDATA[<p>In this post, I revisit the question of whether Google Latitude meets my
persistent location tracking needs. In <a href="/blog/2012/10/29/persistent-location-tracking-picking-the-right-tool/">my previous post</a>, I compared
Google Latitude to InstaMapper and concluded that the latter is too
battery-intensive. By looking at maps and base-level insights from the data,
I suggest that Google Latitude optimizes for battery life at the expense of
data quality.</p>

<!-- more -->

<h2 id="exhibit-a-some-maps">Exhibit A: Some Maps</h2>

<p>I started gathering data on Oct. 3, 2012:</p>

<p><img src="https://lh5.googleusercontent.com/-kyl-kUDWe_M/UJgVi3pls3I/AAAAAAAAALg/zGsaBfNzY7s/s640/map-monthly.jpg"></p>

<p>Since then, <a href="http://www.eecs.berkeley.edu/~valkyrie/">Valkyrie Savage</a> and I have travelled to Boston and Chicago.
Our stopover in Phoenix is clearly visible at this scale. You can barely make
out our day trip to <a href="http://goo.gl/maps/rLfNu">Mount Monadnock, NH</a> over near Boston. Here’s a
closer look at that trip:</p>

<p><img src="https://lh4.googleusercontent.com/-YJQip0zWnxQ/UJgVlFc_7pI/AAAAAAAAAMA/DjlCRjxouzo/s640/map-monadnock-trip.jpg"></p>

<p>Ouch. The data is <em>noisy in some areas, sparse in others.</em> It’s fairly clear that
we took Hwy 2 over, but <em>some of the GPS readings are miles off.</em> Let’s zoom in
on that hike:</p>

<p><img src="https://lh5.googleusercontent.com/-bg3DxaZTe6k/UJgVlqpW7ZI/AAAAAAAAAMI/t2Kn3hrhWJM/s640/map-monadnock-hike.jpg"></p>

<p>Only five data points actually lie within the park/mountain boundaries. That’s
<em>five data points for a four-hour hike.</em> Our Boston data is somewhat more
accurate:</p>

<p><img src="https://lh3.googleusercontent.com/-6RFwbwjBEtI/UJgVmQk1KCI/AAAAAAAAAMQ/-Nhyp0LtoLw/s640/map-monadnock-boston.jpg"></p>

<p>Still, the red line cuts through city blocks with reckless abandon. Either 
we’re flying, or we’re packing some incredibly efficient demolition equipment.</p>

<p>Here’s the map for one of my more itinerant Bay Area days:</p>

<p><img src="https://lh5.googleusercontent.com/-xNNR5dnNV44/UJgVj3SZAEI/AAAAAAAAALw/6KvtDZYWel0/s640/map-busy-day.jpg"></p>

<p>I cycled to a doctor’s appointment, visited
<a href="http://bid.berkeley.edu/">BiD</a> to hear <a href="http://research.microsoft.com/en-us/people/marycz/">Mary Czerwinski</a> speak about emotion tracking, worked
from <a href="http://goo.gl/maps/z7EuA">home</a> for a bit, went into San Francisco to meet up with
<a href="http://www.linkedin.com/in/levpopov">Lev Popov</a>, and finally dragged myself home again.</p>

<p>The BART ride into San Francisco is understandably sparse: most of it is
separated from cell towers and GPS satellites by rock and/or water.</p>

<p>Most of my travel is on foot, by bike, or via public transit. Not content
with the Mount Monadnock hike data, I tried another quick drive up into
<a href="http://goo.gl/maps/zk3AD">Tilden</a>:</p>

<p><img src="https://lh5.googleusercontent.com/-MCZ55KYjgcE/UJgVjNWQ0FI/AAAAAAAAALo/pibM6xiJmUE/s640/map-drive-test.jpg"></p>

<p>Google Latitude captured <em>just four points during the 20-minute drive.</em></p>

<h2 id="exhibit-b-some-analysis">Exhibit B: Some Analysis</h2>

<p>You can see the code for this analysis
<a href="https://github.com/candu/quantified-savagery-files/tree/master/Location/kml">here</a>
and <a href="https://github.com/candu/quantified-savagery-files/tree/master/Location/api">here</a>.</p>

<p>After trudging through several lackluster map views, I’m left with a
nagging impression:</p>

<p><blockquote><p>This data isn’t that useful.</p></blockquote></p>

<p>This impression deserves further analysis, so I grab the KML to answer some
of my questions. First off: <em>how often is Google Latitude checking my location?</em></p>

<p><img src="https://lh5.googleusercontent.com/-A7we5G7pYIw/UJb-xhCk_oI/AAAAAAAAAKk/O7ZwpxF_uQs/s640/timings-frequency.jpg"></p>

<p><em>About every two minutes.</em> GPS is a <a href="/blog/2012/10/29/persistent-location-tracking-picking-the-right-tool/">huge battery drain</a>;
increasing the time between updates can help by allowing the GPS radio to
enter an idle state. <em>How are those location readings scheduled?</em></p>

<p><img src="https://lh6.googleusercontent.com/-PMYu61X440I/UJb-yCEbuBI/AAAAAAAAAKs/umbJNuuVfo0/s640/timings-second-histogram.jpg"></p>

<p>Google Latitude really likes spacing its readings out by a <em>whole number of
minutes.</em></p>

<p><em>How accurate is the data?</em> The KML doesn’t provide <a href="http://en.wikipedia.org/wiki/Dilution_of_precision_(GPS)">accuracy estimates</a>
for its locations. Fortunately, the <a href="https://developers.google.com/latitude/">Google Latitude API</a> does, so
I retrieve my data using <a href="https://github.com/candu/quantified-savagery-files/blob/master/Location/api/scrape.py">this script</a> and look at the accuracy readings:</p>

<p><img src="https://lh3.googleusercontent.com/-p5senVUtgqM/UJb-ybk3zEI/AAAAAAAAAK0/qUvLSvog15E/s640/accuracy-histogram.jpg"></p>

<p>Actually, <em>the readings have fairly high accuracy.</em> Only 7% of readings have a
reported error radius greater than 100m.</p>

<p>The maps above suggest that location readings are less accurate while
travelling at high speed. Is that true? The API provides speed estimates
for some readings, but this data is kind of sparse:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python speed.py &lt; history.api 
</span><span class='line'>found 7429 speed values among 20898 readings</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>I try a different method: the <a href="http://mathforum.org/library/drmath/view/51879.html">Haversine distance formula</a>, which
gives me the distance between two points on the Earth’s surface:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">haversineDistance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
</span><span class='line'>  <span class="err">“””</span>
</span><span class='line'>  <span class="n">Distance</span> <span class="p">(</span><span class="ow">in</span> <span class="n">meters</span><span class="p">)</span> <span class="n">between</span> <span class="n">two</span> <span class="n">Locations</span><span class="o">.</span> <span class="n">Uses</span> <span class="n">the</span> <span class="n">Haversine</span> <span class="n">formula</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">See</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">movable</span><span class="o">-</span><span class="nb">type</span><span class="o">.</span><span class="n">co</span><span class="o">.</span><span class="n">uk</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">latlong</span><span class="o">.</span><span class="n">html</span> <span class="k">for</span> <span class="n">corresponding</span>
</span><span class='line'>  <span class="n">JavaScript</span> <span class="n">implementation</span><span class="o">.</span>
</span><span class='line'>  <span class="err">“””</span>
</span><span class='line'>  <span class="c"># Earth’s radius in meters</span>
</span><span class='line'>  <span class="n">R</span> <span class="o">=</span> <span class="mi">6371009</span>
</span><span class='line'>  <span class="n">dLat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span class='line'>  <span class="n">dLon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">lng</span> <span class="o">-</span> <span class="n">A</span><span class="o">.</span><span class="n">lng</span><span class="p">)</span>
</span><span class='line'>  <span class="n">lat1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span class='line'>  <span class="n">lat2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sLat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dLat</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sLon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dLon</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">a</span> <span class="o">=</span> <span class="n">sLat</span> <span class="o">*</span> <span class="n">sLat</span> <span class="o">+</span> <span class="n">sLon</span> <span class="o">*</span> <span class="n">sLon</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
</span><span class='line'>  <span class="n">c</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>I use this distance formula to get a plot of accuracy versus travelling speed:</p>

<p><img src="https://lh5.googleusercontent.com/-ba4lES16aCU/UJb-ytwI4OI/AAAAAAAAAK8/-OZvTHzgZjk/s144/accuracy-vs-speed.jpg"></p>

<p><em>No clear correlation here</em>; there are low-quality readings at both low and high
speeds. There are several possible explanations:</p>

<ul>
  <li><strong>Confirmation bias:</strong> I mistakenly extrapolated a small handful of
low-quality readings taken at high speeds to a general pattern.</li>
  <li><strong>Misinterpretation:</strong> Some of the Mount Monadnock readings look way off;
perhaps the error radius doesn’t mean what I think it does.</li>
  <li><strong>Different location sources:</strong> Location accuracy is
<a href="http://en.wikipedia.org/wiki/Dilution_of_precision_(GPS)">relatively well-defined</a> for GPS, but I’m not sure what happens when
cell towers or WiFi access points are incorporated into location fixes.</li>
  <li><strong>Longer sampling interval:</strong> Maybe Google Latitude assumes that precise
location tracking is less important when driving.</li>
</ul>

<p>To test this last hypothesis, I also <em>plot sampling interval versus speed:</em></p>

<p><img src="https://lh5.googleusercontent.com/-__3m3z_oQfQ/UJcC4GeNhyI/AAAAAAAAALQ/HI6XQdHjtns/s640/timings-vs-speed.jpg"></p>

<p>Nothing conclusive there.</p>

<h2 id="conclusion">Conclusion</h2>

<p><em>The problem appears to be sampling frequency.</em> To reduce battery usage, <em>Google
Latitude polls about once every two minutes.</em> While it has some mechanism for
polling more often in periods of high activity, it’s unclear how that works.</p>

<p>Reliance on fixes from cell towers and WiFi may be reducing location quality
in more remote areas. Testing this hypothesis is difficult: how do you
quantify remote? One possibility is to compute nearest-neighbor distance
against <a href="http://www.maxmind.com/en/worldcities">a database of cities</a>. Another confounding factor is the
reliability of those <code>accuracy</code> values. Improving upon that would likely
involve manual labelling.</p>

<h2 id="why-do-this">Why Do This?</h2>

<p><blockquote><p>Accuracy is not binary.</p></blockquote></p>

<p>In Quantified Self applications, we <em>use personal data to drive changes in our
lives.</em> We put a lot of trust in the accuracy and relevance of that data, and
<em>we extend that trust to the tools and services that collect it.</em>
We trust <a href="http://www.fitbit.com/">Fitbit</a> to track our fitness.
We trust <a href="http://www.myzeo.com/sleep/">Zeo</a> to improve our sleep.
We trust <a href="http://www.lumosity.com/">Lumosity</a> to train our perception and attentiveness.</p>

<p>In giving so much trust to these tools, we sometimes forget that <em>data are not
infallible.</em>
<a href="http://www.pbs.org/wgbh/aso/databank/entries/dp27un.html">Physics guarantees</a> that there is no such thing as perfect data. <em>All
data contain error.</em> As a system consisting of geosynchronous satellites that
travel at relativistically significant speeds and beam data
through our multilayered atmosphere to tiny chip radios sandwiched between
layers of dense circuitry, GPS is understandably <a href="http://www.kowoma.de/en/gps/errors.htm">error-prone.</a>
When your chosen tools and services add noise on top of that, it’s reasonable
to ask:</p>

<p><blockquote><p>How much trust should I place in the output?</p></blockquote></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Persistent Location Tracking: Picking The Right Tool]]></title>
    <link href="http://blog.savageevan.com/blog/2012/10/29/persistent-location-tracking-picking-the-right-tool/"/>
    <updated>2012-10-29T18:37:00-07:00</updated>
    <id>http://blog.savageevan.com/blog/2012/10/29/persistent-location-tracking-picking-the-right-tool</id>
    <content type="html"><![CDATA[<p>In this post, I compare Google Latitude and InstaMapper, two popular services
for persistent location tracking. I walk through installation and data
extraction via API for each service, then provide some subjective first
impressions as to which one better suits my location-tracking needs.</p>

<!-- more -->

<h2 id="evaluating-tools">Evaluating Tools</h2>

<p>As the ecosystem of self-tracking tools <a href="http://quantifiedself.com/2011/03/the-state-of-quantified-self-a-year-of-growth/">grows exponentially</a>,
choosing the right tool is becoming an increasingly daunting task.
To add to the complexity of this decision, self-tracking tools are
<em>highly personal.</em></p>

<p><blockquote><p>How do I pick the best tool for me?</p></blockquote></p>

<p>This question is far from monolithic:</p>

<ul>
  <li>Do I want <strong>manual</strong> or <strong>automatic</strong> tracking?
    <ul>
      <li>How much <em>time and effort</em> am I willing to spend on self-tracking?</li>
      <li>Is a hybrid <em>automatic plus manual annotation</em> approach workable?</li>
    </ul>
  </li>
  <li>Do I want <strong>persistent</strong> tracking?
    <ul>
      <li><em>All day?</em> Or only at predetermined times?</li>
      <li><em>Every day?</em> What if I’m on vacation?</li>
    </ul>
  </li>
  <li>Do I want <strong>raw data access?</strong>
    <ul>
      <li>How do I want to access that data? Through <em>Excel CSV files?</em>
Via a <em>developer-friendly API?</em></li>
      <li>What <em>granularity</em> do I want? Sub-second? Daily?</li>
      <li>What <em>parameters</em> do I want? For location, is <code>(lat, long)</code> enough?
Do I want <em>altitude</em> as well? GPS fix <em>accuracy?</em></li>
    </ul>
  </li>
</ul>

<p>Without a <em>searchable database of self-tracking tools</em>, these questions can be
difficult to answer. The main <a href="http://quantifiedself.com/">Quantified Self website</a> includes a
<a href="http://quantifiedself.com/guide/">Guide to Self-Tracking Tools</a>, but their implementation is subject to
criticism:</p>

<p><blockquote><p>In a report to RWJF, Project Director Alexandra C. Carmichael noted that the guide was more a catalog of tools than a useful manual for people wanting to choose and use these tools.</p><footer><strong>Robert Wood Johnson Foundation</strong> <cite><a href='http://www.rwjf.org/content/dam/farm/reports/program_results_reports/2012/rwjf400733'>www.rwjf.org/content/dam/farm/&hellip;</a></cite></footer></blockquote></p>

<p>This is a point worth repeating. Simply listing tools is <em>not enough</em>; a
database of tools <em>must answer these basic questions</em> to be useful. A quick
search on the Guide for <a href="http://quantifiedself.com/guide/tag/location">location-related tools</a>
comes up short:</p>

<p><img src="https://lh6.googleusercontent.com/-1r1swg9oBxo/UJA_is6HMSI/AAAAAAAAAIQ/zoiBG4fRAPU/s640/qs-guide-location-apps.jpg"></p>

<p>Why is <a href="http://moodpanda.com/">MoodPanda</a> listed? I suppose it must location-tag mood entries,
but <em>that isn’t made explicit in the description.</em>
<a href="http://www.momentoapp.com/">Momento</a> makes a bit more sense, but it’s primarily a journalling app.
<a href="https://foursquare.com/">Foursquare</a> is definitely location-based, but anyone unfamiliar with
it <em>must read its description closely</em> to realize that it relies on
manual check-ins.</p>

<p>In lieu of a useful tool database, the only effective option is direct
evaluation. By investigating two popular location tracking tools, I’ll
demonstrate how such an evaluation might be carried out.</p>

<h2 id="the-tools">The Tools</h2>

<h3 id="google-latitude">Google Latitude</h3>

<p>Google Latitude bills itself primarily as a social location sharing service:</p>

<p><img src="https://lh5.googleusercontent.com/-ZGGebfguFEk/UJA_hShHXRI/AAAAAAAAAH4/kziP-01pI_g/s800/banner-glatitude.jpg"></p>

<p>Social capacities aside, the <a href="https://maps.google.com/locationhistory/b/0">Location History</a>
functionality can be used as a persistent location-tracking tool.</p>

<h3 id="instamapper">InstaMapper</h3>

<p>I first heard of InstaMapper from
<a href="http://vimeo.com/8545134">Ted Power’s talk on geo-tracking</a>. Unlike Google
Latitude, InstaMapper focuses more on personal tracking:</p>

<p><img src="https://lh4.googleusercontent.com/-dOIGJWcJ7uc/UJA_h8QM2FI/AAAAAAAAAIA/0owDXIrD6Ro/s800/banner-instamapper.jpg"></p>

<h3 id="the-criteria">The Criteria</h3>

<p>My ideal location tracking tool is:</p>

<ul>
  <li><strong>Android-compatible:</strong> It should work with my <a href="www.razr.com/RAZR-M">RAZR M</a> running
<a href="http://www.android.com/about/ice-cream-sandwich/">Android 4.0.4 (Ice Cream Sandwich)</a>.</li>
  <li><strong>Battery-friendly:</strong> It should allow me to go at least a day <em>without
recharging.</em></li>
  <li><strong>Automatic:</strong> It should track my location <em>without requiring check-ins</em>
or other manual input.</li>
  <li><strong>Persistent:</strong> It should track my location <em>constantly.</em></li>
  <li><strong>Fine-grained:</strong> It should be capable of <em>per-minute resolution or better.</em></li>
  <li><strong>Developer-friendly:</strong> It should <em>provide an API</em> for fetching location
history, and the data offered through that API should be <em>as complete as
possible.</em></li>
</ul>

<p>Both tools are <em>Android-compatible</em>, <em>automatic</em>, and <em>persistent</em> already,
which narrows down the list of criteria to evaluate.</p>

<h2 id="installation">Installation</h2>

<h3 id="google-latitude-1">Google Latitude</h3>

<p>Enabling automatic location tracking on Android requires <em>only a single
setting change:</em></p>

<p><img src="https://lh4.googleusercontent.com/-lGwyff6IKAQ/UJA_jzsY3CI/AAAAAAAAAIw/qgFZr8kT1xE/s288/install-glatitude-step1.jpg">
<img src="https://lh5.googleusercontent.com/-v-7rvy4kAk4/UJA_kbfLddI/AAAAAAAAAI4/MLzFAjPXgR8/s288/install-glatitude-step2.jpg">
<img src="https://lh3.googleusercontent.com/-rooAhkMibWg/UJA_kjz8o1I/AAAAAAAAAJA/sCnrK_yNHbE/s288/install-glatitude-step3.jpg">
<img src="https://lh5.googleusercontent.com/-8jz3N_5HkUA/UJA_k6mNTAI/AAAAAAAAAJI/qerZyoCzXbo/s288/install-glatitude-step4.jpg"></p>

<h3 id="instamapper-1">InstaMapper</h3>

<p>I followed the Android installation directions <a href="http://www.instamapper.com/android_howto.html">here</a>.
After you <a href="https://www.instamapper.com/fe?page=register">register for an InstaMapper account</a>, you install
InstaMapper’s <a href="https://play.google.com/store/apps/details?id=com.instamapper.gpstracker&amp;hl=en">GPS Tracker app</a>:</p>

<p><img src="https://lh5.googleusercontent.com/-FJZ7CxlpWSE/UJA_lDw4OVI/AAAAAAAAAJQ/pCreIS9emn0/s288/install-instamapper-step1.jpg"></p>

<h3 id="comparison">Comparison</h3>

<p>Both tools are easily installed, but <em>Google Latitude</em> wins on simplicity. This
is unsurprising, as Google Latitude comes pre-installed.</p>

<h2 id="data-export">Data Export</h2>

<h3 id="google-latitude-2">Google Latitude</h3>

<p>To export data from the Location History dashboard, click on <em>Export KML</em>
under the calendar widget:</p>

<p><img src="https://lh3.googleusercontent.com/-N_E7GC01k3I/UJA_lY310cI/AAAAAAAAAJY/B6qCcqCAPm0/s800/export-glatitude.jpg"></p>

<h3 id="instamapper-2">InstaMapper</h3>

<p>Head to the <em>data page</em> for your device:</p>

<p><img src="https://lh4.googleusercontent.com/-WiPRLpRcC9Q/UJA_l7UA-cI/AAAAAAAAAJg/ienRb1xYY2o/s400/export-instamapper-step1.jpg">
<img src="https://lh4.googleusercontent.com/-kvWTFuAZoJ8/UJA_mK_zsbI/AAAAAAAAAJk/aG-iJs2Sfp8/s400/export-instamapper-step2.jpg"></p>

<p>Here’s where this process gets weird. To export your data, you first have to
<em>define a track:</em></p>

<p><img src="https://lh3.googleusercontent.com/-0j8AdUIinoU/UJA_msnEnLI/AAAAAAAAAKM/LfOZOnEyOJA/s400/export-instamapper-step3.jpg">
<img src="https://lh5.googleusercontent.com/-aiXmPGeKOxo/UJA_nRZr93I/AAAAAAAAAJ0/wWNddc34ZXo/s400/export-instamapper-step4.jpg">
<img src="https://lh6.googleusercontent.com/-tgipa_V9TfU/UJA_ncU8LeI/AAAAAAAAAJ8/2HIvGJ_ycfY/s400/export-instamapper-step5.jpg"></p>

<p>Once the track is created, you can <em>visit the Track Manager</em> to
export your track data in a variety of formats:</p>

<p><img src="https://lh6.googleusercontent.com/-OyteTDJcqYk/UJA_n7L2QvI/AAAAAAAAAKE/tvEkdMbB-Ik/s400/export-instamapper-step6.jpg">
<img src="https://lh5.googleusercontent.com/-e52trEcnN0I/UJA_ob4XGgI/AAAAAAAAAKI/REcryQodFq0/s400/export-instamapper-step7.jpg"></p>

<h3 id="comparison-1">Comparison</h3>

<p>This one goes to <em>Google Latitude</em>. Aside from the terrible UI flow,
InstaMapper has some other problems:</p>

<ul>
  <li>The <code>accuracy</code> field is missing, making it harder to <em>filter out noisy
readings.</em></li>
  <li>As stated in the <a href="http://www.instamapper.com/faq.html">InstaMapper FAQ</a>,
data access is <em>limited to the
previous 30 days or 100 000 locations.</em></li>
</ul>

<h2 id="api-fetching">API Fetching</h2>

<h3 id="tailers-and-streams">Tailers and Streams</h3>

<p>Many real-time APIs provide <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> endpoints for fetching
time-bounded chunks of data:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://www.googleapis.com/latitude/v1/location?key=INSERT-YOUR-KEY&amp;min-time=1111&amp;max-time=2222&amp;max-results=10</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>By keeping track of a <code>since</code> time to fetch after, we can easily turn this
into a stream:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">since</span><span class="p">):</span>
</span><span class='line'>  <span class="c"># TODO: actually fetch data</span>
</span><span class='line'>  <span class="k">pass</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">since</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
</span><span class='line'>  <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">since</span>
</span><span class='line'>  <span class="n">wait</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">wait</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="n">freq</span><span class="p">):</span>
</span><span class='line'>  <span class="n">since</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class='line'>  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sleep</span><span class="p">(</span><span class="n">since</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
</span><span class='line'>    <span class="n">locations</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">since</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">locations</span><span class="p">:</span>
</span><span class='line'>      <span class="k">continue</span>
</span><span class='line'>    <span class="n">doSomething</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
</span><span class='line'>    <span class="n">since</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This pattern is often referred to as a <em>tailer.</em> Why? Suppose we have a simple
implementation of <code>doSomething()</code>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">doSomething</span><span class="p">(</span><span class="n">locations</span><span class="p">):</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">location</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This prints out locations as they are received, similar to UNIX <code>tail -F</code>. By
adjusting <code>freq</code> I can make different real-time guarantees, although at some
point the upstream API will start throttling my requests.</p>

<h3 id="google-latitude-3">Google Latitude</h3>

<p>You can see a working tailer implementation <a href="https://github.com/candu/quantified-savagery-files/blob/master/Location/tail_glatitude.py">here</a>.</p>

<p>To access the <a href="https://developers.google.com/latitude/">Google Latitude API</a>, you first need to
<a href="https://code.google.com/apis/console/b/0/">register an application</a>. This gives you the necessary
parameters <code>YOUR_KEY</code>, <code>YOUR_SECRET</code> for stepping through the OAuth flow.</p>

<p>With the Python library <a href="http://code.google.com/p/google-api-python-client/wiki/OAuth2Client">oauthclient2</a>, retrieving OAuth credentials is
relatively painless:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">OAuth2WebServerFlow</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">oauth2client.file</span> <span class="kn">import</span> <span class="n">Storage</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">oauth2client.tools</span> <span class="kn">import</span> <span class="n">run</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">getCredentials</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
</span><span class='line'>  <span class="n">flow</span> <span class="o">=</span> <span class="n">OAuth2WebServerFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">client_id</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
</span><span class='line'>    <span class="n">client_secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
</span><span class='line'>    <span class="n">scope</span><span class="o">=</span><span class="err">’</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">auth</span><span class="o">/</span><span class="n">latitude</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">best</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>    <span class="n">redirect_uri</span><span class="o">=</span><span class="err">’</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">oauth2callback</span><span class="err">’</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="n">storage</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span><span class="err">‘</span><span class="o">.</span><span class="n">creds</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">run</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">storage</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>oauth2client.tools.run()</code> invokes a browser window and starts an HTTP server
to receive the OAuth callback. With the credentials, we can <em>make a signed API
request:</em></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">httplib2</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">since</span><span class="p">):</span>
</span><span class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">()</span>
</span><span class='line'>  <span class="n">credentials</span> <span class="o">=</span> <span class="n">getCredentials</span><span class="p">(</span><span class="n">YOUR_KEY</span><span class="p">,</span> <span class="n">YOUR_SECRET</span><span class="p">)</span>
</span><span class='line'>  <span class="n">credentials</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="err">‘</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">latitude</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">location</span><span class="err">?</span><span class="o">%</span><span class="n">s</span><span class="err">’</span> <span class="o">%</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span>
</span><span class='line'>    <span class="err">‘</span><span class="nb">max</span><span class="o">-</span><span class="n">results</span><span class="err">’</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'>    <span class="err">‘</span><span class="nb">min</span><span class="o">-</span><span class="n">time</span><span class="err">’</span><span class="p">:</span> <span class="n">since</span><span class="p">,</span>
</span><span class='line'>    <span class="err">‘</span><span class="nb">max</span><span class="o">-</span><span class="n">time</span><span class="err">’</span><span class="p">:</span> <span class="n">since</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">granularity</span><span class="err">’</span><span class="p">:</span> <span class="err">‘</span><span class="n">best</span><span class="err">’</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="n">resp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="err">‘</span><span class="n">error</span><span class="err">’</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>    <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="err">‘</span><span class="n">data</span><span class="err">’</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="err">‘</span><span class="n">items</span><span class="err">’</span><span class="p">,</span> <span class="p">[])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>There are some minor details:</p>

<ul>
  <li>The API <em>uses milliseconds for its timestamps</em>, so my <code>since</code> values take
this into account.</li>
  <li>Without <code>max-time</code>, the API <em>returns the most recent</em> <code>max-results</code> locations.
I supply a 150-second window.</li>
  <li>If there are no locations within the given time range, the API <strong>does not</strong>
populate <code>data['data']['items']</code>. I use <code>get()</code> to work around the resulting
<code>KeyError</code>.</li>
  <li>In the event of an error, the API populates <code>data['error']</code>. I use <code>None</code> as
a <em>sentinel value</em> to indicate that an error has occurred.</li>
</ul>

<h3 id="instamapper-3">InstaMapper</h3>

<p>You can see a working tailer implementation <a href="https://github.com/candu/quantified-savagery-files/blob/master/Location/tail_instamapper.py">here</a>.</p>

<p>InstaMapper doesn’t use OAuth; instead, it uses a unique key
<code>YOUR_KEY</code> that is passed as a GET parameter to the REST API:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">httplib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">since</span><span class="p">):</span>
</span><span class='line'>  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">action</span><span class="err">’</span><span class="p">:</span> <span class="err">‘</span><span class="n">getPositions</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">key</span><span class="err">’</span><span class="p">:</span> <span class="n">YOUR_KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">num</span><span class="err">’</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">from_ts</span><span class="err">’</span><span class="p">:</span> <span class="n">since</span><span class="p">,</span>
</span><span class='line'>    <span class="err">‘</span><span class="n">format</span><span class="err">’</span><span class="p">:</span> <span class="err">‘</span><span class="n">json</span><span class="err">’</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="err">‘</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">instamapper</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="err">?</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="err">’</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">APIHOST</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
</span><span class='line'>  <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="err">‘</span><span class="n">www</span><span class="o">.</span><span class="n">instamapper</span><span class="o">.</span><span class="n">com</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="err">‘</span><span class="n">GET</span><span class="err">’</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="err">‘</span><span class="n">HTTP</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="err">’</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="err">‘</span><span class="n">positions</span><span class="err">’</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3 id="comparison-2">Comparison</h3>

<p>Although InstaMapper’s API is arguably simpler to use, I’ll award this one to
<em>Google Latitude:</em></p>

<ul>
  <li><strong>Security:</strong> InstaMapper uses unencrypted HTTP GET requests, so anyone
running a <a href="http://www.wireshark.org/">packet sniffer</a> on my network has <em>complete access to my
location data.</em> Google Latitude uses HTTPS and OAuth. No contest.</li>
  <li><strong>Support:</strong> I can <em>leverage the community of Google API users</em> to help resolve
any issues I encounter.</li>
  <li><strong>Data:</strong> again, InstaMapper is <em>missing location accuracy.</em></li>
  <li><strong>Request Volume:</strong> InstaMapper permits one request every 10 seconds. Google
Latitude allows 1 000 000 requests per day, or <em>one request every 0.0864
seconds.</em></li>
</ul>

<h2 id="battery-usage">Battery Usage</h2>

<p>To find out how battery-friendly the two Android apps are, I <em>check the
Battery Manager:</em></p>

<p><img src="https://lh6.googleusercontent.com/-B246p7a_vbg/UJA_i7iGdyI/AAAAAAAAAIU/Q6U6hLdc2hg/s288/battery-overview.jpg">
<img src="https://lh5.googleusercontent.com/-X6ClOm7t-8s/UJA_jVwjgrI/AAAAAAAAAIk/V1lOfjmpO2o/s288/battery-maps.jpg">
<img src="https://lh5.googleusercontent.com/-r7N176E75z0/UJA_jdJfs_I/AAAAAAAAAIg/XQnPc0Q2lgY/s288/battery-gps-tracker.jpg"></p>

<h3 id="comparison-3">Comparison</h3>

<p><em>Google Latitude</em> wins this one as well. InstaMapper keeps the GPS radio
running almost constantly, whereas Google Latitude manages to sip radio
access. I’m guessing that it uses WiFi, cell towers, and other non-GPS sources
where possible.</p>

<p>Without these power consumption improvements, InstaMapper’s GPS Tracker <em>uses
an order of magnitude more energy</em> than Google Latitude. Ouch.</p>

<h2 id="first-impressions">First Impressions</h2>

<p>After a day of persistent location tracking with both Google Latitude and
InstaMapper, <em>Google Latitude wins hands-down.</em> It’s <em>easy to install</em>, it
provides <em>simple and secure data access</em> via <code>oauth2client</code>, and it <em>preserves
battery life nicely.</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Don't Hate, Cross-Correlate]]></title>
    <link href="http://blog.savageevan.com/blog/2012/10/22/dont-hate-cross-correlate/"/>
    <updated>2012-10-22T13:41:00-07:00</updated>
    <id>http://blog.savageevan.com/blog/2012/10/22/dont-hate-cross-correlate</id>
    <content type="html"><![CDATA[<p>In this post, I discuss cross-correlation. Although commonly used in signal
processing, cross-correlation can be useful in a Quantified Self context.
I’ll present a bit of the mathematics behind cross-correlation, demonstrate
a quick example, and briefly explain where you might use this in analyzing
your personal data.</p>

<!-- more -->

<h2 id="the-inspiration">The Inspiration</h2>

<p>I was going through my <a href="http://reader.google.com">Google Reader</a> queue this morning and
came across <a href="http://vimeo.com/50329491">this talk</a> by <a href="http://www.linkedin.com/in/jeffzira">Jeff Zira</a>, a product manager at
<a href="http://www.lark.com/">Lark Technologies</a>. The talk asks a simple question:</p>

<p><blockquote><p>Do Jeff and his fiancée influence each other’s sleep patterns?</p></blockquote></p>

<p>He presents raw time-series sleep data collected using
<a href="http://www.lark.com/products/lark-life/experience">larklife</a>, then attempts to answer this question in a couple of
different ways. He first displays a <em>timeline visualization</em> of peak
overnight activity:</p>

<p><img src="https://lh6.googleusercontent.com/-nU3qiQKycow/UIbogGdHsGI/AAAAAAAAAHY/Ax23iCZB98M/s640/jeffzira-peak-vis.jpg"></p>

<p>Since his peaks often occur slightly after her peaks, he uses this as
evidence that she’s waking him up. He also shows the <em>difference signal</em>
between their sleep patterns, but finds this less than conclusive:</p>

<p><img src="https://lh4.googleusercontent.com/-GAskT1r-gP4/UIbogcHUqCI/AAAAAAAAAHc/XbCl5IvAves/s640/jeffzira-diff-vis.jpg"></p>

<p>After watching this talk, I immediately thought:</p>

<p><blockquote><p>Is there a more precise way to answer this question?</p></blockquote></p>

<h2 id="the-mathematics">The Mathematics</h2>

<p>Note that term <em>difference signal</em> above. Any time-series dataset is a signal,
which means the powerful tools of signal processing can be applied!</p>

<p>Let the sleep patterns of Jeff and his fiancée be the signals
$ S(\tau) $ and $ T(\tau) $ respectively. Let $ f(S(\tau), T(\tau)) $ be the
<em>similarity</em> between those signals. Ignoring (for now) the fact that $ f $
remains undefined, I’m looking for the <em>time shift</em> $ t $ that maximizes</p>

<script type="math/tex; mode=display">
f(S(\tau + t), T(\tau))
</script>

<p>(As a side note, the <em>difference signal</em> is a new signal
$ R(\tau) = S(\tau) - T(\tau) $.)</p>

<p>First, however, I need a reasonable <em>similarity function</em> $ f $. The answer
lies in <em>cross-correlation:</em></p>

<p><blockquote><p>In signal processing, cross-correlation is a measure of similarity of two waveforms as a function of a time-lag applied to one of them.</p><footer><strong>Wikipedia</strong> <cite><a href='http://en.wikipedia.org/wiki/Cross-correlation'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote></p>

<p>Perfect! The core of cross-correlation is an integral that looks suspiciously
like <a href="http://en.wikipedia.org/wiki/Convolution">convolution</a>, except that we have a term $ T(\tau + t) $ instead
of $ T(\tau - t) $:</p>

<script type="math/tex; mode=display">
(S \star T)(t) = \int_{-\infty}^{\infty} S^{\ast}(\tau) T(\tau + t) \mathrm{d}\tau
</script>

<p>The desired $ t $ is the <em>global maximum</em> of this cross-correlation function.</p>

<p>Given two discrete periodic signals <code>S1</code>, <code>S2</code> of equal length, this
cross-correlation integral can easily be computed:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">crossCorrelation</span><span class="p">(</span><span class="nx">S1</span><span class="p">,</span> <span class="nx">S2</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">N</span> <span class="o">=</span> <span class="nx">S1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">%</span> <span class="nx">N</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">t</span> <span class="o">+=</span> <span class="nx">N</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">tau</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">tau</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nx">N</span><span class="p">;</span> <span class="nx">tau</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">C</span> <span class="o">+=</span> <span class="nx">S1</span><span class="p">[</span><span class="nx">tau</span><span class="p">]</span> <span class="o">*</span> <span class="nx">S2</span><span class="p">[(</span><span class="nx">tau</span> <span class="o">+</span> <span class="nx">t</span><span class="p">)</span> <span class="o">%</span> <span class="nx">N</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">C</span> <span class="o">/</span> <span class="nx">N</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>It can be hard to visualize what this is doing, though, so I’ve provided
a <a href="#quick-demo">quick demo</a> below.</p>

<h3 id="an-interactive-example">An Interactive Example</h3>

<p>If you’re viewing this on an RSS reader, check out the example
<a href="/blog/2012/10/22/dont-hate-cross-correlate/#quick-demo">on my blog</a>.</p>

<p>You can see the code for this demo <a href="https://github.com/candu/quantified-savagery-files/tree/master/Algorithms/cross-correlation">here</a>.</p>

<div id="quick-demo">
  <style type="text/css">
    #datasets {
      cursor: move;
    }
    
    #cross-correlation {
      margin-top: 10px;
    }
    
    path {
      stroke-width: 2px;
    }
    
    path.s1 {
      fill: rgba(210, 0, 0, 0.4);
    }
    
    path.s2 {
      fill: rgba(0, 0, 210, 0.4);
    }
    
    path.c {
      fill: rgba(126, 0, 210, 0.64);
    }
    
    line {
      stroke: rgba(64, 64, 64, 0.7);
      stroke-width: 1px;
    }
    
    line.t {
      stroke: rgba(32, 32, 32, 0.8);
      stroke-width: 2px;
    }
    
    #status {
      color: #909;
      font-family: "Menlo", monospace;
      padding-bottom: 10px;
    }
    
    #s1-picker {
      background-color: rgba(210, 0, 0, 0.7);
    }
    
    #s2-picker {
      background-color: rgba(0, 0, 210, 0.7);
    }  
  </style>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/lib/js/ArrayUtils.js"></script>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/lib/js/MathUtils.js"></script>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/lib/js/third-party/mootools.js"></script>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/lib/js/third-party/d3.js"></script>
  <script src="https://raw.github.com/candu/quantified-savagery-files/master/Algorithms/cross-correlation/demo.js"></script>
  <div id="controls">
    <select id="s1-picker">
      <option value="sine" selected="">Sine</option>
      <option value="noise">Noise</option>
      <option value="spiky">Spiky</option>
      <option value="square">Square</option>
      <option value="triangle">Triangle</option>
    </select>
    <select id="s2-picker">
      <option value="sine" selected="">Sine</option>
      <option value="noise">Noise</option>
      <option value="spiky">Spiky</option>
      <option value="square">Square</option>
      <option value="triangle">Triangle</option>
    </select>
  </div>
  <div id="datasets"></div>
  <div id="cross-correlation"></div>
  <div id="status"></div>
</div>

<p>Use the select boxes to change the red and blue functions. Click and drag
on the chart at top to see how sliding the blue function affects the
cross-correlation. Try different combinations of functions and <em>see where
the cross-correlation is maximized!</em></p>

<h3 id="back-to-the-original-motivation">Back To The Original Motivation</h3>

<p>Given the two sleep signals $ S, T $ above, cross-correlation makes it
possible to answer these questions:</p>

<ul>
  <li>Who wakes up first? By how long?</li>
  <li>Accounting for the time shift in awakening, how closely do the sleep
patterns match?</li>
</ul>

<p>This gives a <em>more rigorous</em> sense of whether the peaks in nighttime activity
actually do coincide. It also identifies the person who wakes up first and
how much earlier they wake up.</p>

<p>While simply <em>looking at the data</em> can be very effective, rigorous analysis
has definite value if you plan to <em>carry out further experiments.</em> Armed with
cross-correlation data, you can answer questions like</p>

<p><blockquote><p>Okay, I switched to a separately-coiled mattress. How well does that prevent<br/>us from waking each other up?</p></blockquote></p>

<p>In general, <em>signal processing</em> techniques can be highly useful in examining
time-series data.</p>

<h2 id="up-next">Up Next</h2>

<p>This was a slight diversion from my plan to talk about
upcoming experiments, which I’ll return to in my next few posts. If you
just can’t wait, here’s a <em>quick summary:</em></p>

<ul>
  <li><strong>Persistent location tracking:</strong> by <em>constantly tracking my location</em>, I’ll
have an additional dataset to correlate against.</li>
  <li><strong>Diet:</strong> by <em>taking meal photos</em>, <em>tagging foods</em>, and <em>measuring
stress levels after meals</em>, I’ll get a better idea of how different
foods affect me.</li>
  <li><strong>Finances:</strong> by <em>tracking where Valkyrie and I spend our money</em>, we’ll
hopefully be able to better control our discretionary spending.</li>
  <li><strong>Loss Aversion:</strong> by <em>experimenting with tracking methods</em>, I’ll see if this
is something that can be meaningfully tracked over time.</li>
</ul>
]]></content>
  </entry>
  
</feed>
